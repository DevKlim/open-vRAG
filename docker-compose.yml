# docker-compose.yml
services:
  videochat_webui:
    build: .
    container_name: videochat_webui
    # The --reload flag tells uvicorn to automatically restart the server
    # whenever it detects a code change in the mounted volume.
    command: python -m uvicorn app:app --host 0.0.0.0 --port 8000 --reload
    ports:
      - "8005:8000"
    volumes:
      # --- IMPORTANT FOR PERFORMANCE & PERSISTENCE ---
      # The following volumes are crucial to avoid re-downloading large files (like models)
      # every time you restart the container. Make sure these local directories exist.

      # Mount the current directory for live code changes in development
      - .:/app

      # Mount a local directory to cache Hugging Face models and other assets.
      # This prevents re-downloading multi-gigabyte models on every startup.
      # ON YOUR HOST: Create a directory named `huggingface_cache` in this folder.
      - ./huggingface_cache:/root/.cache/huggingface

      # Mount a local directory to store downloaded videos from the web UI.
      - ./videos:/app/videos

      # Mount a local directory for datasets used by fine-tuning scripts.
      - ./data:/app/data

      # OPTIONAL BUT RECOMMENDED FOR STARTUP SPEED: Pre-download the model.
      # 1. Download the model: `git lfs install && git clone https://huggingface.co/OpenGVLab/VideoChat-R1_5`
      # 2. Rename the downloaded `VideoChat-R1_5` folder to `model` and place it in this project's root directory.
      # The application will then load the model directly from this folder instead of downloading it.
      - ./model:/app/local_model # This maps your local `model` folder into the container.
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    stdin_open: true
    tty: true